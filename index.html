
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI Scent Matching — Maison Margiela (Demo)</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --card:#ffffff;
      --ink:#111111;
      --muted:#6b6b6b;
      --line:#e8e8e8;
      --shadow:0 18px 46px rgba(0,0,0,.10);
      --shadow2:0 14px 34px rgba(0,0,0,.14);
      --radius:18px;
      --radius2:14px;
      --btn:#111;
      --btnText:#fff;
      --danger:#b00020;
      --ok:#0b6b3a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    .wrap{max-width:980px;margin:0 auto;padding:18px 18px 34px;}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:12px 6px 10px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand .kicker{letter-spacing:.18em;text-transform:uppercase;font-size:11px;color:var(--muted);}
    .brand h1{margin:0;font-size:20px;letter-spacing:.02em;font-weight:650;}
    .brand .sub{margin:0;font-size:13px;color:var(--muted);line-height:1.35;max-width:560px;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;
      background:rgba(255,255,255,.75);border:1px solid var(--line);
      border-radius:999px;box-shadow:0 8px 22px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);user-select:none;
    }
    .pill b{font-size:12px}
    .pill span{font-size:12px;color:var(--muted)}

    .progressWrap{
      margin:0 6px 14px;padding:14px 14px 12px;background:rgba(255,255,255,.75);
      border:1px solid var(--line);border-radius:var(--radius2);
      box-shadow:0 10px 28px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);
    }
    .progressRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .progressRow .label{font-size:12px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;}
    .progressRow .stepText{font-size:12px;color:var(--muted);}
    .bar{height:8px;border-radius:999px;background:#e9e9e9;overflow:hidden;}
    .bar>i{display:block;height:100%;width:0%;background:#111;border-radius:999px;transition:width .35s ease;}

    /* Single card stage */
    .stage{
      position:relative;
      min-height: 520px;
    }

    .card{
      position:absolute;
      left:0; right:0;
      margin:0 6px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      opacity:0;
      transform: translateY(12px);
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
    }
    .card.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }
    .card.exitLeft{
      opacity:0;
      transform: translateX(-18px) translateY(6px);
      pointer-events:none;
    }

    .hero{
      padding:22px 22px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0));
    }
    .hero .title{margin:0 0 6px;font-size:18px;font-weight:700;letter-spacing:.01em;}
    .hero .hint{margin:0;font-size:13px;color:var(--muted);line-height:1.4;}

    .body{padding:18px 22px 22px;}
    .q{margin:2px 0 12px;font-size:15px;font-weight:700;letter-spacing:.01em;}
    .qmeta{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;color:var(--muted);font-size:12px;}
    .qmeta .limit{padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#fafafa;}

    .grid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:10px;}
    @media (min-width:860px){.grid.grid-3{grid-template-columns:repeat(3, minmax(0, 1fr));}}
    @media (max-width:520px){.grid{grid-template-columns:1fr;}}

    .opt{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      min-height:48px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .opt:active{transform:scale(.99);}
    .opt:hover{box-shadow:0 10px 22px rgba(0,0,0,.06);}
    .opt .txt{font-size:14px;font-weight:650;}
    .opt .mini{font-size:12px;color:var(--muted);font-weight:500;}
    .opt .mark{
      width:22px;height:22px;border-radius:999px;border:1px solid var(--line);
      display:grid;place-items:center;font-size:13px;color:transparent;background:#fff;flex:0 0 auto;transition:all .12s ease;
    }
    .opt.on{border-color:#111;background:#111;color:#fff;box-shadow:var(--shadow2);}
    .opt.on .mini{color:rgba(255,255,255,.75);}
    .opt.on .mark{border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.12);color:#fff;}

    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      font-size:14px;
      outline:none;
      background:#fff;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .input:focus{border-color:#111;box-shadow:0 0 0 4px rgba(0,0,0,.06);}

    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 18px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:750;font-size:14px;cursor:pointer;
      transition:transform .12s ease, opacity .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;min-width:120px;
    }
    .btn:active{transform:scale(.99);}
    .btn.primary{background:var(--btn);color:var(--btnText);box-shadow:0 14px 30px rgba(0,0,0,.18);}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink);}
    .btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;}
    .note{font-size:12px;color:var(--muted);flex:1;text-align:center;padding:0 8px;}
    .warn{color:var(--danger);font-weight:750;}
    .ok{color:var(--ok);font-weight:750;}

    /* Results */
    .personaBox{
      padding:14px;border-radius:14px;border:1px solid var(--line);background:#fafafa;margin:12px 0 6px;
    }
    .personaBox .p1{font-size:12px;color:var(--muted);margin:0 0 4px;letter-spacing:.14em;text-transform:uppercase;}
    .personaBox .p2{margin:0;font-size:15px;font-weight:850;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .chip{background:#f1f1f1;color:#111;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);}

    .gallery{
      display:flex;gap:12px;overflow-x:auto;padding:12px 2px 2px;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;
    }
    .gallery::-webkit-scrollbar{height:8px;}
    .gallery::-webkit-scrollbar-thumb{background:#e1e1e1;border-radius:999px;}

    .scentCard{
      flex:0 0 300px;scroll-snap-align:start;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff;
      box-shadow:0 14px 30px rgba(0,0,0,.08);transform:translateY(8px);opacity:0;animation:cardIn .35s ease forwards;
    }
    @keyframes cardIn{to{transform:translateY(0);opacity:1;}}
    .scentTop{padding:14px 14px 12px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .rank{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);}
    .sname{margin:4px 0 0;font-size:16px;font-weight:850;letter-spacing:.01em;}
    .scentBody{padding:14px;display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center;}
    .imgWrap{width:110px;height:140px;border:1px solid var(--line);border-radius:14px;background:#fbfbfb;display:grid;place-items:center;overflow:hidden;position:relative;}
    .imgWrap img{width:100%;height:100%;object-fit:cover;display:block;}
    .imgHint{
      position:absolute;bottom:8px;left:8px;right:8px;font-size:11px;color:rgba(17,17,17,.65);
      background:rgba(255,255,255,.75);border:1px solid var(--line);border-radius:999px;padding:5px 8px;text-align:center;
      backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);
    }
    .sdesc{margin:0;font-size:13px;color:var(--muted);line-height:1.4;}
    .tags{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
    .tag{background:#f3f3f3;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#111;}
    .ctaRow{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;}
    .miniBtn{border:1px solid var(--line);background:#fff;color:#111;border-radius:12px;padding:10px 12px;font-size:13px;font-weight:750;cursor:pointer;}

    /* Toast */
    .toast{position:fixed;left:18px;right:18px;bottom:18px;max-width:980px;margin:0 auto;display:none;z-index:50;}
    .toast .tbox{
      background:#111;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:13px;
    }
    .toast button{border:none;background:rgba(255,255,255,.12);color:#fff;border-radius:10px;padding:8px 10px;font-weight:850;cursor:pointer;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="kicker">AI SCENT MATCHING · SINGLE-CARD FLOW</div>
        <h1>Maison Margiela — Replica</h1>
        <p class="sub">Each question appears as one card. Once answered, it disappears and the next card slides in.</p>
      </div>
      <div class="pill">
        <b>Demo</b><span>iPad-friendly</span>
      </div>
    </div>

    <div class="progressWrap">
      <div class="progressRow">
        <div class="label">progress</div>
        <div class="stepText" id="stepText">1 / 8</div>
      </div>
      <div class="bar"><i id="barFill"></i></div>
    </div>

    <div class="stage" id="stage">

      <!-- Card 1 -->
      <section class="card active" data-step="0">
        <div class="hero">
          <p class="title">Scent Preference Test</p>
          <p class="hint">Go with your intuition. Your choices map to scent families and use contexts.</p>
        </div>
        <div class="body">
          <div class="q">1) Are you new to fragrance or experienced?</div>
          <div class="qmeta"><div>Sets “safe” vs “bold” boundaries.</div><div class="limit">Single</div></div>
          <div class="grid">
            <div class="opt" data-q="level" data-type="single" data-val="beginner">
              <div><div class="txt">First-time user</div><div class="mini">Easy-to-wear</div></div><div class="mark">✓</div>
            </div>
            <div class="opt" data-q="level" data-type="single" data-val="expert">
              <div><div class="txt">Experienced</div><div class="mini">More character</div></div><div class="mark">✓</div>
            </div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back0" disabled>Back</button>
          <div class="note" id="note0"><span class="warn">Please select one option.</span></div>
          <button class="btn primary" type="button" id="next0" disabled>Next</button>
        </div>
      </section>

      <!-- Card 2 -->
      <section class="card" data-step="1">
        <div class="hero">
          <p class="title">Usage Context</p>
          <p class="hint">Select where you actually wear fragrance.</p>
        </div>
        <div class="body">
          <div class="q">2) In which situations do you wear fragrance? (Up to 3)</div>
          <div class="qmeta"><div>Builds your “use-case profile”.</div><div class="limit">Multi (max 3)</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="daily"><div class="txt">Daily life</div><div class="mini">clean / effortless</div><div class="mark">✓</div></div>
            <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="work"><div class="txt">Work / business</div><div class="mini">controlled / elegant</div><div class="mark">✓</div></div>
            <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="date"><div class="txt">Date / dinner</div><div class="mini">warm / attractive</div><div class="mark">✓</div></div>
            <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="travel"><div class="txt">Travel</div><div class="mini">airy / free</div><div class="mark">✓</div></div>
            <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="sport"><div class="txt">Sport / active</div><div class="mini">fresh / light</div><div class="mark">✓</div></div>
            <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="event"><div class="txt">Formal event</div><div class="mini">statement / bold</div><div class="mark">✓</div></div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back1">Back</button>
          <div class="note" id="note1"><span class="warn">Select at least one context.</span></div>
          <button class="btn primary" type="button" id="next1" disabled>Next</button>
        </div>
      </section>

      <!-- Card 3 -->
      <section class="card" data-step="2">
        <div class="hero">
          <p class="title">City Profile</p>
          <p class="hint">Optional—helps environment tuning.</p>
        </div>
        <div class="body">
          <div class="q">3) Which city do you spend most of the year in? (Optional)</div>
          <div class="qmeta"><div>Used for cool/warm & dry/humid adjustments.</div><div class="limit">Input</div></div>
          <input class="input" id="cityInput" placeholder="e.g., Paris / Tokyo / London / Shanghai / Singapore" />
          <div class="qmeta" style="margin-top:10px"><div>You can skip for demo.</div><div class="limit">Optional</div></div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back2">Back</button>
          <div class="note" id="note2"><span class="ok">You can continue.</span></div>
          <button class="btn primary" type="button" id="next2">Next</button>
        </div>
      </section>

      <!-- Card 4 -->
      <section class="card" data-step="3">
        <div class="hero">
          <p class="title">Atmospheres</p>
          <p class="hint">Memory anchors to narrow direction.</p>
        </div>
        <div class="body">
          <div class="q">4) Which scent atmospheres do you prefer? (Up to 2)</div>
          <div class="qmeta"><div>Pick 1–2 that feel most “you”.</div><div class="limit">Multi (max 2)</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="rain"><div class="txt">After the rain</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="coffee"><div class="txt">Coffee & vanilla</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="paper"><div class="txt">Books & woods</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="whitefloral"><div class="txt">Rose & white flowers</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="citrus"><div class="txt">Citrus & sunshine</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="bread"><div class="txt">Freshly baked bread</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="oldwood"><div class="txt">Old wooden furniture</div><div class="mark">✓</div></div>
            <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="laundry"><div class="txt">Clean laundry</div><div class="mark">✓</div></div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back3">Back</button>
          <div class="note" id="note3"><span class="warn">Select 1–2 atmospheres.</span></div>
          <button class="btn primary" type="button" id="next3" disabled>Next</button>
        </div>
      </section>

      <!-- Card 5 -->
      <section class="card" data-step="4">
        <div class="hero">
          <p class="title">Scent Families</p>
          <p class="hint">Your core preference.</p>
        </div>
        <div class="body">
          <div class="q">5) Which scent families attract you most? (Up to 2)</div>
          <div class="qmeta"><div>Determines the matching direction.</div><div class="limit">Multi (max 2)</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="citrus"><div><div class="txt">Citrus</div><div class="mini">bright / crisp</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="floral"><div><div class="txt">Floral</div><div class="mini">petal / soft</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="amber"><div><div class="txt">Amber / sweet</div><div class="mini">warm / comforting</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="woody"><div><div class="txt">Woody</div><div class="mini">dry / structured</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="green"><div><div class="txt">Green / herbal</div><div class="mini">airy / natural</div></div><div class="mark">✓</div></div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back4">Back</button>
          <div class="note" id="note4"><span class="warn">Select 1–2 families.</span></div>
          <button class="btn primary" type="button" id="next4" disabled>Next</button>
        </div>
      </section>

      <!-- Card 6 (Conditional) -->
      <section class="card" data-step="5">
        <div class="hero">
          <p class="title">Preference Detail</p>
          <p class="hint">This question adapts to your selection.</p>
        </div>
        <div class="body">
          <div class="q">6) A quick calibration</div>
          <div class="qmeta"><div id="calibHint">Based on your families from the previous step.</div><div class="limit">Single</div></div>

          <div id="sweetBlock" style="display:none">
            <div class="qmeta" style="margin-top:0"><div><b>Sweetness tolerance</b> (Citrus / Floral / Amber)</div><div class="limit">Single</div></div>
            <div class="grid grid-3">
              <div class="opt" data-q="sweetness" data-type="single" data-val="none"><div><div class="txt">Not at all</div><div class="mini">dry / clean</div></div><div class="mark">✓</div></div>
              <div class="opt" data-q="sweetness" data-type="single" data-val="light"><div><div class="txt">Light</div><div class="mini">a touch of sweetness</div></div><div class="mark">✓</div></div>
              <div class="opt" data-q="sweetness" data-type="single" data-val="medium"><div><div class="txt">Moderate</div><div class="mini">balanced</div></div><div class="mark">✓</div></div>
              <div class="opt" data-q="sweetness" data-type="single" data-val="high"><div><div class="txt">Sweet</div><div class="mini">gourmand leaning</div></div><div class="mark">✓</div></div>
            </div>
          </div>

          <div id="smokyBlock" style="display:none;margin-top:14px">
            <div class="qmeta" style="margin-top:0"><div><b>Smoky / leather / oud tolerance</b> (Woody / Green)</div><div class="limit">Single</div></div>
            <div class="grid grid-3">
              <div class="opt" data-q="smoky" data-type="single" data-val="none"><div><div class="txt">Not at all</div><div class="mini">clean woods</div></div><div class="mark">✓</div></div>
              <div class="opt" data-q="smoky" data-type="single" data-val="low"><div><div class="txt">A little</div><div class="mini">subtle depth</div></div><div class="mark">✓</div></div>
              <div class="opt" data-q="smoky" data-type="single" data-val="medium"><div><div class="txt">Moderate</div><div class="mini">noticeable</div></div><div class="mark">✓</div></div>
              <div class="opt" data-q="smoky" data-type="single" data-val="high"><div><div class="txt">I love it</div><div class="mini">bold & smoky</div></div><div class="mark">✓</div></div>
            </div>
          </div>

          <div class="qmeta" style="margin-top:14px">
            <div>If neither block appears, you can continue.</div>
            <div class="limit">Adaptive</div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back5">Back</button>
          <div class="note" id="note5"><span class="ok">Continue when ready.</span></div>
          <button class="btn primary" type="button" id="next5">Next</button>
        </div>
      </section>

      <!-- Card 7 -->
      <section class="card" data-step="6">
        <div class="hero">
          <p class="title">Intensity</p>
          <p class="hint">Controls freshness vs richness.</p>
        </div>
        <div class="body">
          <div class="q">7) Do you prefer fresh or intense scents?</div>
          <div class="qmeta"><div>Tunes projection & richness.</div><div class="limit">Single</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="intensity" data-type="single" data-val="very-fresh"><div><div class="txt">Very fresh</div><div class="mini">airy / clean</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="intensity" data-type="single" data-val="balanced"><div><div class="txt">Balanced</div><div class="mini">versatile</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="intensity" data-type="single" data-val="rich"><div><div class="txt">More intense</div><div class="mini">deeper</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="intensity" data-type="single" data-val="very-rich"><div><div class="txt">Very intense</div><div class="mini">statement</div></div><div class="mark">✓</div></div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back6">Back</button>
          <div class="note" id="note6"><span class="warn">Please select one option.</span></div>
          <button class="btn primary" type="button" id="next6" disabled>Next</button>
        </div>
      </section>

      <!-- Card 8 -->
      <section class="card" data-step="7">
        <div class="hero">
          <p class="title">Impression</p>
          <p class="hint">Defines your scent persona.</p>
        </div>
        <div class="body">
          <div class="q">8) What impression do you want to leave? (Up to 2)</div>
          <div class="qmeta"><div>Pick the most important two.</div><div class="limit">Multi (max 2)</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="clean"><div class="txt">Clean & professional</div><div class="mark">✓</div></div>
            <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="soft"><div class="txt">Soft & comforting</div><div class="mark">✓</div></div>
            <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="cool"><div class="txt">Cool & luxurious</div><div class="mark">✓</div></div>
            <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="sexy"><div class="txt">Seductive</div><div class="mark">✓</div></div>
            <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="relaxed"><div class="txt">Relaxed & effortless</div><div class="mark">✓</div></div>
            <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="mysterious"><div class="txt">Mysterious & unique</div><div class="mark">✓</div></div>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back7">Back</button>
          <div class="note" id="note7"><span class="warn">Select up to 2 impressions.</span></div>
          <button class="btn primary" type="button" id="next7" disabled>See results</button>
        </div>
      </section>

      <!-- Results Card -->
      <section class="card" data-step="8">
        <div class="hero">
          <p class="title">Your Results</p>
          <p class="hint">Swipe the cards on iPad. This is a demo recommender based on your selections.</p>
        </div>
        <div class="body">
          <div class="personaBox">
            <p class="p1">Your Scent Persona</p>
            <p class="p2" id="personaLine">—</p>
            <div class="chips" id="chipLine"></div>
          </div>

          <div class="personaBox" id="reasonBox" style="margin-top:12px">
           <p class="p1">WHY THESE PICKS</p>
           <div id="reasonLines" style="margin-top:6px"></div>
          </div>


          <div class="gallery" id="gallery"></div>

          <div class="ctaRow">
            <button class="miniBtn" type="button" id="btnRestart">Restart</button>
            <button class="miniBtn" type="button" id="btnCopy">Copy summary</button>
          </div>
        </div>
        <div class="footer">
          <button class="btn ghost" type="button" id="back8">Back</button>
          <div class="note"><span class="ok">Done.</span></div>
          <button class="btn primary" type="button" id="next8" disabled>Done</button>
        </div>
      </section>

    </div>
  </div>

  <div class="toast" id="toast">
    <div class="tbox">
      <div id="toastMsg">Saved</div>
      <button type="button" id="toastBtn">OK</button>
    </div>
  </div>

  <script>
    // ---------------- State ----------------
    const state = {
  level: null,
  scene: [],
  city: "",
  vibe: [],
  family: [],
  sweetness: null,
  smoky: null,
  intensity: null,
  impression: [],

  // NEW: weather snapshot for explanations
  wx: { temp: null, rh: null, climate: null, label: null },

  // NEW: cache to avoid repeated calls
  wxCache: {}
};


    const cards = Array.from(document.querySelectorAll(".card"));
    const total = 8; // questions count (results not counted)
    let step = 0;

    const stepText = document.getElementById("stepText");
    const barFill  = document.getElementById("barFill");

    const cityInput = document.getElementById("cityInput");
    const sweetBlock = document.getElementById("sweetBlock");
    const smokyBlock = document.getElementById("smokyBlock");

    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    const toastBtn = document.getElementById("toastBtn");

    const personaLine = document.getElementById("personaLine");
    const chipLine = document.getElementById("chipLine");
    const gallery = document.getElementById("gallery");

    const btnRestart = document.getElementById("btnRestart");
    const btnCopy = document.getElementById("btnCopy");

    function showToast(msg){
      toastMsg.textContent = msg;
      toast.style.display = "block";
      toastBtn.onclick = () => (toast.style.display = "none");
      setTimeout(() => { toast.style.display = "none"; }, 1800);
    }

    function shouldAskSweetness(){
      return state.family.some(x => ["citrus","floral","amber"].includes(x));
    }
    function shouldAskSmoky(){
      return state.family.some(x => ["woody","green"].includes(x));
    }

    function updateConditional(){
      const sweet = shouldAskSweetness();
      const smoky = shouldAskSmoky();
      sweetBlock.style.display = sweet ? "block" : "none";
      smokyBlock.style.display = smoky ? "block" : "none";
      if (!sweet) state.sweetness = null;
      if (!smoky) state.smoky = null;

      document.querySelectorAll('[data-q="sweetness"]').forEach(el => el.classList.toggle("on", el.dataset.val === state.sweetness));
      document.querySelectorAll('[data-q="smoky"]').forEach(el => el.classList.toggle("on", el.dataset.val === state.smoky));
      validateCard(5);
    }

    function setProgress(questionIndex){
      // questionIndex is 0..7; results card is 8
      if (questionIndex <= 7){
        stepText.textContent = `${questionIndex + 1} / ${total}`;
        barFill.style.width = `${(questionIndex / (total - 1)) * 100}%`;
      } else {
        stepText.textContent = `${total} / ${total}`;
        barFill.style.width = `100%`;
      }
    }

    function showCard(idx){
      cards.forEach(c => c.classList.remove("active","exitLeft"));
      const current = cards[idx];
      current.classList.add("active");
      step = idx;
      setProgress(Math.min(idx, 7));
      window.scrollTo({top:0, behavior:"smooth"});
      if (idx === 2) setTimeout(() => cityInput.focus(), 120);
    }

    function goNext(){
      const cur = step;
      // animate exit
      cards[cur].classList.add("exitLeft");
      setTimeout(() => {
        showCard(cur + 1);
      }, 180);
    }

    function goBack(){
      const cur = step;
      showCard(Math.max(0, cur - 1));
    }

    // ---------------- Validation per card ----------------
    function setNote(cardIdx, ok, text){
      const n = document.getElementById(`note${cardIdx}`);
      const next = document.getElementById(`next${cardIdx}`);
      if (!n || !next) return;
      n.innerHTML = ok ? `<span class="ok">${text || "Ready."}</span>` : `<span class="warn">${text}</span>`;
      next.disabled = !ok;
    }

    function validateCard(cardIdx){
      // cardIdx corresponds to question steps 0..7
      if (cardIdx === 0){
        const ok = !!state.level;
        setNote(0, ok, ok ? "Ready." : "Please select one option.");
      }
      if (cardIdx === 1){
        const ok = state.scene.length > 0;
        setNote(1, ok, ok ? "Ready." : "Select at least one context.");
      }
      if (cardIdx === 2){
        setNote(2, true, "You can continue.");
      }
      if (cardIdx === 3){
        const ok = state.vibe.length > 0;
        setNote(3, ok, ok ? "Ready." : "Select 1–2 atmospheres.");
      }
      if (cardIdx === 4){
        const ok = state.family.length > 0;
        setNote(4, ok, ok ? "Ready." : "Select 1–2 families.");
      }
      if (cardIdx === 5){
        const needSweet = shouldAskSweetness();
        const needSmoky = shouldAskSmoky();
        let ok = true;
        let msg = "You can continue.";
        if (needSweet && !state.sweetness){ ok = false; msg = "Select your sweetness tolerance."; }
        if (needSmoky && !state.smoky){ ok = false; msg = "Select your smoky tolerance."; }
        setNote(5, ok, msg);
      }
      if (cardIdx === 6){
        const ok = !!state.intensity;
        setNote(6, ok, ok ? "Ready." : "Please select one option.");
      }
      if (cardIdx === 7){
        const ok = state.impression.length > 0;
        setNote(7, ok, ok ? "Ready." : "Select up to 2 impressions.");
      }
    }

    // ---------------- Option toggles ----------------
    function toggleOption(el){
      const q = el.dataset.q;
      const type = el.dataset.type;
      const val = el.dataset.val;

      if (type === "single"){
        state[q] = val;
        document.querySelectorAll(`.opt[data-q="${q}"]`).forEach(x => x.classList.remove("on"));
        el.classList.add("on");
      } else {
        const max = parseInt(el.dataset.max || "99", 10);
        const arr = state[q] || [];
        const idx = arr.indexOf(val);

        if (idx >= 0){
          arr.splice(idx, 1);
          el.classList.remove("on");
        } else {
          if (arr.length >= max){
            showToast(`Max ${max} selections.`);
            return;
          }
          arr.push(val);
          el.classList.add("on");
        }
        state[q] = arr;
      }

      // conditional refresh
      if (q === "family") updateConditional();

      // validate current card
      validateCard(step);

      // Auto-advance: single-choice cards advance immediately (after a tiny delay)
      const autoAdvanceSingles = new Set([0, 6]); // level, intensity
      if (type === "single" && autoAdvanceSingles.has(step)){
        const nextBtn = document.getElementById(`next${step}`);
        if (nextBtn && !nextBtn.disabled){
          setTimeout(() => nextBtn.click(), 180);
        }
      }
    }

   
    // city input
    cityInput.addEventListener("input", () => { state.city = cityInput.value.trim(); });

 

   // ---------------- Weather → Climate (no API key) ----------------
async function hydrateWeatherFromCity(){
  const city = (state.city || "").trim();
  if (!city) {
    state.wx = { temp:null, rh:null, climate:null, label:null };
    return;
  }

  // cache hit
  if (state.wxCache[city]) {
    state.wx = state.wxCache[city];
    return;
  }

  try{
    // 1) City -> lat/lon
    const gUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&format=json`;
    const g = await fetch(gUrl).then(r=>r.json());
    const hit = g?.results?.[0];
    if (!hit) {
      state.wx = { temp:null, rh:null, climate:null, label:null };
      return;
    }

    // 2) Lat/lon -> current temp + humidity
    const wUrl = `https://api.open-meteo.com/v1/forecast?latitude=${hit.latitude}&longitude=${hit.longitude}&current=temperature_2m,relative_humidity_2m`;
    const w = await fetch(wUrl).then(r=>r.json());
    const temp = w?.current?.temperature_2m;
    const rh   = w?.current?.relative_humidity_2m;

    const { climate, label } = classifyClimate(temp, rh);
    const wx = { temp, rh, climate, label };

    state.wx = wx;
    state.wxCache[city] = wx; // cache
  }catch(e){
    state.wx = { temp:null, rh:null, climate:null, label:null };
  }
}

// Simple 4-bucket classifier
function classifyClimate(temp, rh){
  if (temp == null || rh == null) return { climate:null, label:null };

  const warm  = temp >= 22;   // threshold: warm
  const humid = rh >= 65;     // threshold: humid

  if (warm && humid)  return { climate:"warm_humid", label:"warm & humid" };
  if (warm && !humid) return { climate:"warm_dry",   label:"warm & dry" };
  if (!warm && humid) return { climate:"cool_humid", label:"cool & humid" };
  return { climate:"cool_dry", label:"cool & dry" };
}

// ---------------- 3-sentence explanation ----------------
function climateReason(){
  const wx = state.wx || {};
  if (!wx.label || wx.temp == null || wx.rh == null) {
    return "Based on your location, we kept the match balanced for comfort.";
  }
  const t = Math.round(wx.temp);
  const h = Math.round(wx.rh);

  if (wx.climate === "warm_humid") return `In ${wx.label} weather (${t}°C, ${h}% RH), lighter and fresher scents feel cleaner on skin.`;
  if (wx.climate === "warm_dry")   return `In ${wx.label} weather (${t}°C, ${h}% RH), crisp fresh notes stay comfortable and not heavy.`;
  if (wx.climate === "cool_humid") return `In ${wx.label} weather (${t}°C, ${h}% RH), clean musks and soft woods feel refined and cozy.`;
  return `In ${wx.label} weather (${t}°C, ${h}% RH), warmer notes develop more depth and often last longer.`;
}

function sceneReason(scene){
  const s = new Set(scene || []);
  if (s.has("work")) return "You wear fragrance for work, so a controlled and polished presence matters most.";
  if (s.has("date") || s.has("event")) return "You wear fragrance for dates/events, so character and memorability matter more.";
  if (s.has("sport")) return "You wear fragrance in active moments, so freshness and breathability are key.";
  if (s.has("travel")) return "You wear fragrance while traveling, so versatility and a clean impression help most.";
  return "You mainly wear fragrance in daily life, so an easy, versatile profile fits best.";
}

function scentReason(p){
  // Use your existing vec to explain in 1 line
  if (p.vec.clean >= 3) return "This scent leans clean and skin-like, staying effortless and close throughout the day.";
  if (p.vec.fresh >= 3) return "This scent emphasizes airy freshness, keeping it light and breathable on skin.";
  if (p.vec.amber >= 3) return "This scent adds warm amber comfort, creating a more intimate and cozy trail.";
  if (p.vec.woody >= 3) return "This scent is built around structured woods, adding depth without feeling messy.";
  if (p.vec.green >= 3) return "This scent highlights green herbal facets, giving a natural and uplifting feeling.";
  return "This scent stays balanced across notes, matching multiple parts of your profile.";
}

function buildReason3(p){
  return [ climateReason(), sceneReason(state.scene), scentReason(p) ];
}

    // ---------------- Matching ----------------
    const scents = [
    // ===== 你原来的 8 个（保留原图） =====
    {
      key:"lazy_sunday_morning",
      name:"Lazy Sunday Morning",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-lazy-sunday-morning-S33YX0018S10932001.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dwd5bce2b7/images/large/S33YX0018_S10932_001_F.jpg",
      tags:["Clean","Musky","Soft Floral"],
      desc:"Clean linen, soft musk, gentle florals — effortless and intimate.",
      vec:{ fresh:3, floral:2, amber:0, woody:0, green:1, clean:3, sweet:0, smoky:0, bold:0 }
    },
    {
      key:"bubble_bath",
      name:"Bubble Bath",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-bubble-bath-S33YX0087S11972961.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dw5e3bda35/images/large/S33YX0087_S11972_961_F.jpg",
      tags:["Soapy","Coconut","Clean"],
      desc:"Soapy cleanliness with a cozy skin-like comfort.",
      vec:{ fresh:3, floral:1, amber:0, woody:0, green:1, clean:3, sweet:1, smoky:0, bold:0 }
    },
    {
      key:"sailing_day",
      name:"Sailing Day",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-sailing-day-S33YX0056S11604961.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dwb34637e5/images/large/S33YX0056_S11604_961_F.jpg",
      tags:["Marine","Fresh","Aromatic"],
      desc:"Oceanic freshness and airy aromatics — crisp and uplifting.",
      vec:{ fresh:4, floral:0, amber:0, woody:0, green:2, clean:2, sweet:0, smoky:0, bold:0 }
    },
    {
      key:"springtime_in_a_park",
      name:"Springtime in a Park",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-springtime-in-a-park-S33YX0078S11919961.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dw90491b11/images/large/S33YX0078_S11919_961_F.jpg",
      tags:["Floral","Green","Bright"],
      desc:"A bright floral bouquet with a fresh spring breeze.",
      vec:{ fresh:2, floral:4, amber:0, woody:0, green:2, clean:1, sweet:1, smoky:0, bold:0 }
    },
    {
      key:"coffee_break",
      name:"Coffee Break",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-coffee-break-S33YX0075S11917961.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dw1c6c7669/images/large/S33YX0075_S11917_961_F.jpg",
      tags:["Coffee","Creamy","Warm"],
      desc:"Coffee-laced comfort with a creamy sweetness.",
      vec:{ fresh:0, floral:1, amber:4, woody:1, green:0, clean:0, sweet:3, smoky:0, bold:1 }
    },
    {
      key:"jazz_club",
      name:"Jazz Club",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-jazz-club-S33YX0016S10930001.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dw4b01e89f/images/large/S33YX0016_S10930_001_F.jpg",
      tags:["Rum","Tobacco","Amber"],
      desc:"Warm rum, tobacco and amber — charismatic and nocturnal.",
      vec:{ fresh:0, floral:0, amber:4, woody:2, green:0, clean:0, sweet:2, smoky:1, bold:2 }
    },
    {
      key:"by_the_fireplace",
      name:"By the Fireplace",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-by-the-fireplace-S33YX0024S11331961.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dwd0b597c5/images/large/S33YX0024_S11331_961_F.jpg",
      tags:["Smoky","Woods","Vanilla"],
      desc:"Smoky woods and toasted warmth — iconic winter comfort.",
      vec:{ fresh:0, floral:0, amber:3, woody:4, green:0, clean:0, sweet:2, smoky:3, bold:2 }
    },
    {
      key:"whispers_in_the_library",
      name:"Whispers in the Library",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-whispers-in-the-library-S33YX0059S11721961.html",
      img:"https://www.maisonmargiela.com/on/demandware.static/-/Sites-margiela-master-catalog/default/dwdad957dd/images/large/S33YX0059_S11721_961_F.jpg",
      tags:["Paper","Woods","Soft Spice"],
      desc:"Paper, woods and soft spice — quiet, intellectual, refined.",
      vec:{ fresh:1, floral:0, amber:1, woody:4, green:0, clean:1, sweet:0, smoky:0, bold:1 }
    },

    // ===== 新增：官网“香水”产品（先不强行填 img，避免错图；下一步你给我图链接我再补全） =====
    {
      key:"beach_walk",
      name:"Beach Walk",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-beach-walk-S33YX0014S10931001.html",
      img:"",
      tags:["Sunny","Salty","Coconut"],
      desc:"A sun-warmed beach memory — salty air and creamy comfort.",
      vec:{ fresh:2, floral:1, amber:1, woody:0, green:0, clean:1, sweet:1, smoky:0, bold:0 }
    },
    {
      key:"under_the_stars",
      name:"Under the Stars",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-under-the-stars-S33YX0124S12594961.html",
      img:"",
      tags:["Warm","Spicy","Resinous"],
      desc:"A night-sky vibe — warm spice and deep, resinous woods.",
      vec:{ fresh:0, floral:0, amber:3, woody:3, green:0, clean:0, sweet:1, smoky:2, bold:2 }
    },
    {
      key:"on_a_date",
      name:"On a Date",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-on-a-date-S33YX0126SV0060961.html",
      img:"",
      tags:["Fruity","Rose","Sunset"],
      desc:"Late-summer Provence — ripe fruit brightness with a rose edge.",
      vec:{ fresh:1, floral:3, amber:1, woody:0, green:1, clean:1, sweet:1, smoky:0, bold:1 }
    },
    {
      key:"matcha_meditation",
      name:"Matcha Meditation",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-matcha-meditation-S33YX0125SV0046961.html",
      img:"",
      tags:["Tea","Creamy","Soft Green"],
      desc:"A creamy matcha moment — gentle green comfort and calm.",
      vec:{ fresh:1, floral:1, amber:1, woody:0, green:3, clean:1, sweet:1, smoky:0, bold:0 }
    },
    {
      key:"from_the_garden",
      name:"From the Garden",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-from-the-garden-S33YX0177M10053961.html",
      img:"",
      tags:["Green","Tomato Leaf","Fresh"],
      desc:"A vivid garden memory — green leaves and crisp freshness.",
      vec:{ fresh:2, floral:0, amber:0, woody:0, green:4, clean:2, sweet:0, smoky:0, bold:0 }
    },
    {
      key:"soul_of_the_forest",
      name:"Soul of the Forest",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-toilette-replica-soul-of-the-forest-S33YX0131SV0086961.html",
      img:"",
      tags:["Forest","Woody","Earthy"],
      desc:"Deep forest air — earthy woods and natural depth.",
      vec:{ fresh:0, floral:0, amber:1, woody:4, green:2, clean:0, sweet:0, smoky:1, bold:1 }
    },
    {
      key:"untitled_edp",
      name:"(untitled) Eau de Parfum",
      url:"https://www.maisonmargiela.com/fr-fr/eau-de-parfum-%28untitled%29-S33YX0134SV0090961.html",
      img:"",
      tags:["Minimal","Clean","Modern"],
      desc:"A minimalist signature — clean modernity with subtle character.",
      vec:{ fresh:2, floral:1, amber:0, woody:1, green:1, clean:3, sweet:0, smoky:0, bold:0 }
    },

    // ===== 新增：官网“香水套装”（也属于香水/香氛产品，你如果不想显示套装，我下一步给你一键关掉） =====
    {
      key:"memory_box_10",
      name:"REPLICA Memory Box Set",
      url:"https://www.maisonmargiela.com/fr-fr/replica-memory-box-set-S33VX0175S14302961.html",
      img:"",
      tags:["Set","Discovery","10×"],
      desc:"A discovery set for sampling multiple REPLICA scents.",
      vec:{ fresh:1, floral:1, amber:1, woody:1, green:1, clean:1, sweet:1, smoky:1, bold:0 }
    },
    {
      key:"memory_box_10_olf",
      name:"REPLICA Memory Box Set",
      url:"https://www.maisonmargiela.com/fr-fr/replica-memory-box-set-S33VX0176S14741961.html",
      img:"",
      tags:["Set","Discovery","10×"],
      desc:"A discovery set for sampling multiple REPLICA scents.",
      vec:{ fresh:1, floral:1, amber:1, woody:1, green:1, clean:1, sweet:1, smoky:1, bold:0 }
    },
    {
      key:"memory_box_7",
      name:"REPLICA Memory Box Set",
      url:"https://www.maisonmargiela.com/fr-fr/replica-memory-box-set-S33VX0177S15793961.html",
      img:"",
      tags:["Set","Discovery","7×"],
      desc:"A compact discovery set — try multiple directions quickly.",
      vec:{ fresh:1, floral:1, amber:1, woody:1, green:1, clean:1, sweet:1, smoky:1, bold:0 }
    },
    {
      key:"memory_box_7_olf",
      name:"REPLICA Memory Box Set",
      url:"https://www.maisonmargiela.com/fr-fr/replica-memory-box-set-S33VX0178S15901961.html",
      img:"",
      tags:["Set","Discovery","7×"],
      desc:"A compact discovery set — try multiple directions quickly.",
      vec:{ fresh:1, floral:1, amber:1, woody:1, green:1, clean:1, sweet:1, smoky:1, bold:0 }
    }
  ];


    function buildUserVector(){
      const v = { fresh:0, floral:0, amber:0, woody:0, green:0, clean:0, sweet:0, smoky:0, bold:0 };

      // level
      if (state.level === "beginner"){ v.clean += 1; v.bold -= 1; }
      if (state.level === "expert"){ v.bold += 1; }

      // scene
      const s = new Set(state.scene);
      if (s.has("daily")){ v.clean += 2; v.fresh += 1; }
      if (s.has("work")){ v.clean += 1; v.woody += 1; }
      if (s.has("date")){ v.amber += 1; v.bold += 1; }
      if (s.has("travel")){ v.fresh += 2; v.green += 1; }
      if (s.has("sport")){ v.fresh += 2; v.clean += 1; }
      if (s.has("event")){ v.bold += 2; v.amber += 1; v.woody += 1; }

      // vibe
      const vibeMap = {
        rain: { fresh:2, green:1 },
        coffee: { amber:2, sweet:1 },
        paper: { woody:2 },
        whitefloral: { floral:2, clean:1 },
        citrus: { fresh:2 },
        bread: { amber:2, sweet:1 },
        oldwood: { woody:2 },
        laundry: { clean:2, fresh:1 }
      };
      state.vibe.forEach(x => {
        const m = vibeMap[x];
        if (!m) return;
        Object.keys(m).forEach(k => v[k] += m[k]);
      });

      // family
      state.family.forEach(x => {
        if (x === "citrus") v.fresh += 3;
        if (x === "floral") v.floral += 3;
        if (x === "amber") v.amber += 3;
        if (x === "woody") v.woody += 3;
        if (x === "green") v.green += 3;
      });

      // sweetness / smoky
      const sweetMap = { none:0, light:1, medium:2, high:3 };
      if (state.sweetness) v.sweet += sweetMap[state.sweetness] ?? 0;

      const smokyMap = { none:0, low:1, medium:2, high:3 };
      if (state.smoky) v.smoky += smokyMap[state.smoky] ?? 0;

      // intensity
      if (state.intensity === "very-fresh"){ v.fresh += 2; v.bold -= 1; }
      if (state.intensity === "balanced"){ v.fresh += 1; v.amber += 1; }
      if (state.intensity === "rich"){ v.amber += 2; v.bold += 1; }
      if (state.intensity === "very-rich"){ v.amber += 3; v.bold += 2; v.woody += 1; }

      // impression
      const imp = new Set(state.impression);
      if (imp.has("clean")){ v.clean += 2; v.fresh += 1; }
      if (imp.has("soft")){ v.floral += 1; v.clean += 1; }
      if (imp.has("cool")){ v.woody += 1; v.clean += 1; }
      if (imp.has("sexy")){ v.amber += 2; v.bold += 1; }
      if (imp.has("relaxed")){ v.fresh += 1; v.green += 1; }
      if (imp.has("mysterious")){ v.woody += 1; v.smoky += 1; v.bold += 1; }

      // city (light heuristic)
      const c = (state.city || "").toLowerCase();
      if (c.includes("paris")){ v.floral += 1; v.clean += 1; }
      if (c.includes("tokyo")){ v.clean += 2; v.fresh += 1; }
      if (c.includes("london")){ v.woody += 1; v.amber += 1; }
      if (c.includes("singapore")){ v.fresh += 2; v.green += 1; }
      if (c.includes("shanghai")){ v.clean += 1; v.fresh += 1; }

      return v;
    }

    function scoreScent(userV, scent){
      let score = 0;
      for (const k in scent.vec) score += (userV[k] || 0) * (scent.vec[k] || 0);
      if ((userV.smoky || 0) === 0 && scent.vec.smoky >= 2) score -= 6;
      if ((userV.sweet || 0) === 0 && scent.vec.sweet >= 2) score -= 5;
      return score;
    }

    function buildPersona(userV){
      const s = new Set(state.scene);
      let context = "Everyday";
      if (s.has("work") && !s.has("event") && !s.has("date")) context = "Work-ready";
      if (s.has("date") || s.has("event")) context = "Evening";
      if (s.has("travel")) context = "Travel";

      const core = Object.entries({
        Clean: userV.clean,
        Fresh: userV.fresh,
        Floral: userV.floral,
        Woody: userV.woody,
        Amber: userV.amber
      }).sort((a,b)=>b[1]-a[1])[0][0];

      const att = (userV.bold >= 3) ? "Statement" : (userV.clean >= 4 ? "Minimal" : "Balanced");
      return `${context} · ${core} · ${att}`;
    }

    function renderResults(){
      const userV = buildUserVector();
      const ranked = scents
        .map(s => ({...s, _score: scoreScent(userV, s)}))
        .sort((a,b)=>b._score-a._score);

      const top3 = ranked.slice(0,3);
      personaLine.textContent = buildPersona(userV);

      chipLine.innerHTML = "";
      const chips = [];
      chips.push(state.level === "beginner" ? "First-time" : "Experienced");
      chips.push(...(state.scene || []).map(x => ({
        daily:"Daily", work:"Work", date:"Date", travel:"Travel", sport:"Sport", event:"Event"
      }[x])));
      chips.push(...(state.family || []).map(x => ({
        citrus:"Citrus", floral:"Floral", amber:"Amber", woody:"Woody", green:"Green"
      }[x])));
      if (state.intensity) chips.push({
        "very-fresh":"Very fresh", "balanced":"Balanced", "rich":"Intense", "very-rich":"Very intense"
      }[state.intensity]);
      chips.slice(0,10).forEach(t => {
        const d = document.createElement("div");
        d.className = "chip";
        d.textContent = t;
        chipLine.appendChild(d);
      });
      const reasonLines = document.getElementById("reasonLines");

// 3-sentence, 3 key points (short)
const core = Object.entries({
  Clean: userV.clean,
  Fresh: userV.fresh,
  Floral: userV.floral,
  Woody: userV.woody,
  Amber: userV.amber,
  Green: userV.green
}).sort((a,b)=>b[1]-a[1])[0][0];

const lines = [
  climateReason(),                         // from temp/rh buckets
  sceneReason(state.scene),                // from scene selection
  `Core direction: ${core} — so we prioritized scents that express this clearly without feeling heavy.`
];

// Render as 3 bullets
reasonLines.innerHTML = `
  <div style="display:grid;gap:8px;font-size:13px;color:#6b6b6b;line-height:1.4">
    ${lines.map(t => `<div>• ${t}</div>`).join("")}
  </div>
`;

      gallery.innerHTML = "";
      top3.forEach((p, idx) => {
        const card = document.createElement("div");
        card.className = "scentCard";
        card.style.animationDelay = `${idx * 90}ms`;
        card.innerHTML = `
          <div class="scentTop">
            <div>
              <div class="rank">Top ${idx+1}</div>
              <div class="sname">${p.name}</div>
            </div>
            <div class="rank">${Math.round(p._score)}</div>
          </div>
          <div class="scentBody">
            <div class="imgWrap">
              <img src="${p.img}" alt="${p.name}">
            </div>
            <div>
              <p class="sdesc">${p.desc}</p>

<p class="sdesc" style="margin-top:6px;font-size:12px;color:#8a8a8a">
  Best for: work · clean woods
</p>

<div class="tags" style="margin-top:10px">
  ${p.tags.map(t => `<span class="tag">${t}</span>`).join("")}
</div>

            </div>
          </div>
        `;
        gallery.appendChild(card);
      });
    }

    // ---------------- Control wiring ----------------
    function bindNav(){
  for (let i=0;i<=8;i++){
    const back = document.getElementById(`back${i}`);
    const next = document.getElementById(`next${i}`);

    if (back) back.addEventListener("click", () => goBack());

    if (next) next.addEventListener("click", async () => {
      if (i === 4) updateConditional();

      if (i === 7){
        // Weather lookup (non-blocking UX)
        const oldText = next.textContent;
        next.disabled = true;
        showToast("Checking local climate…");

        await hydrateWeatherFromCity(); // NEW

        renderResults();
        next.disabled = false;
        next.textContent = oldText;
      }

      goNext();
    });
  }
}


    function goNext(){
      const cur = step;
      cards[cur].classList.add("exitLeft");
      setTimeout(() => showCard(cur + 1), 180);
    }
    function goBack(){
      showCard(Math.max(0, step - 1));
    }

    function showCard(idx){
      cards.forEach(c => c.classList.remove("active","exitLeft"));
      const target = cards[idx];
      if (!target) return;
      target.classList.add("active");
      step = idx;

      // progress only counts question cards 0..7; results is 8
      if (idx <= 7){
        stepText.textContent = `${idx + 1} / ${total}`;
        barFill.style.width = `${(idx / (total - 1)) * 100}%`;
      } else {
        stepText.textContent = `${total} / ${total}`;
        barFill.style.width = `100%`;
      }

      validateCard(Math.min(idx,7));
      window.scrollTo({top:0, behavior:"smooth"});
      if (idx === 2) setTimeout(() => cityInput.focus(), 120);
    }

    // ---------------- Option behavior ----------------
    function toggleOption(el){
      const q = el.dataset.q;
      const type = el.dataset.type;
      const val = el.dataset.val;

      if (type === "single"){
        state[q] = val;
        document.querySelectorAll(`.opt[data-q="${q}"]`).forEach(x => x.classList.remove("on"));
        el.classList.add("on");
      } else {
        const max = parseInt(el.dataset.max || "99", 10);
        const arr = state[q] || [];
        const idx = arr.indexOf(val);
        if (idx >= 0){
          arr.splice(idx, 1);
          el.classList.remove("on");
        } else {
          if (arr.length >= max){
            showToast(`Max ${max} selections.`);
            return;
          }
          arr.push(val);
          el.classList.add("on");
        }
        state[q] = arr;
      }

      if (q === "family") updateConditional();

      validateCard(step);

      // Auto-advance for single-choice cards: card 0 & 6, plus conditional card if only one block shown and chosen
      if (type === "single"){
        const nextBtn = document.getElementById(`next${step}`);
        if (nextBtn && !nextBtn.disabled){
          setTimeout(() => nextBtn.click(), 160);
        }
      }
    }

    let __lastTapAt = 0;

document.querySelectorAll(".opt").forEach((el) => {
  const handler = (e) => {
    // Deduplicate: avoid touchend + click double fire on iOS
    const now = Date.now();
    if (now - __lastTapAt < 250) return;
    __lastTapAt = now;

    e.preventDefault();
    e.stopPropagation();
    toggleOption(el);
  };

  // iOS Safari reliable path
  el.addEventListener("touchend", handler, { passive: false });
  // Desktop fallback
  el.addEventListener("click", handler, { passive: false });
});



    cityInput.addEventListener("input", () => { state.city = cityInput.value.trim(); });

    // ---------------- Validation functions ----------------
    function setNote(cardIdx, ok, text){
      const n = document.getElementById(`note${cardIdx}`);
      const next = document.getElementById(`next${cardIdx}`);
      if (!n || !next) return;
      n.innerHTML = ok ? `<span class="ok">${text || "Ready."}</span>` : `<span class="warn">${text}</span>`;
      next.disabled = !ok;
    }

    function validateCard(cardIdx){
      if (cardIdx === 0){
        setNote(0, !!state.level, state.level ? "Ready." : "Please select one option.");
      }
      if (cardIdx === 1){
        setNote(1, state.scene.length > 0, state.scene.length ? "Ready." : "Select at least one context.");
      }
      if (cardIdx === 2){
        setNote(2, true, "You can continue.");
      }
      if (cardIdx === 3){
        setNote(3, state.vibe.length > 0, state.vibe.length ? "Ready." : "Select 1–2 atmospheres.");
      }
      if (cardIdx === 4){
        setNote(4, state.family.length > 0, state.family.length ? "Ready." : "Select 1–2 families.");
      }
      if (cardIdx === 5){
        const needSweet = shouldAskSweetness();
        const needSmoky = shouldAskSmoky();
        let ok = true;
        let msg = "You can continue.";
        if (needSweet && !state.sweetness){ ok = false; msg = "Select your sweetness tolerance."; }
        if (needSmoky && !state.smoky){ ok = false; msg = "Select your smoky tolerance."; }
        setNote(5, ok, msg);
      }
      if (cardIdx === 6){
        setNote(6, !!state.intensity, state.intensity ? "Ready." : "Please select one option.");
      }
      if (cardIdx === 7){
        setNote(7, state.impression.length > 0, state.impression.length ? "Ready." : "Select up to 2 impressions.");
      }
    }

    // ---------------- Restart / Copy ----------------
    btnRestart.addEventListener("click", () => {
      state.level = null;
      state.scene = [];
      state.city = "";
      state.vibe = [];
      state.family = [];
      state.sweetness = null;
      state.smoky = null;
      state.intensity = null;
      state.impression = [];

      document.querySelectorAll(".opt").forEach(el => el.classList.remove("on"));
      cityInput.value = "";
      sweetBlock.style.display = "none";
      smokyBlock.style.display = "none";

      showToast("Restarted.");
      showCard(0);
    });

    btnCopy.addEventListener("click", async () => {
      const lines = [];
      lines.push("AI Scent Matching — Summary");
      lines.push(`Level: ${state.level === "beginner" ? "First-time user" : "Experienced"}`);
      lines.push(`Contexts: ${(state.scene||[]).join(", ") || "-"}`);
      lines.push(`City: ${state.city || "-"}`);
      lines.push(`Atmospheres: ${(state.vibe||[]).join(", ") || "-"}`);
      lines.push(`Families: ${(state.family||[]).join(", ") || "-"}`);
      lines.push(`Sweetness: ${state.sweetness || "-"}`);
      lines.push(`Smoky: ${state.smoky || "-"}`);
      lines.push(`Intensity: ${state.intensity || "-"}`);
      lines.push(`Impression: ${(state.impression||[]).join(", ") || "-"}`);

      try{
        await navigator.clipboard.writeText(lines.join("\n"));
        showToast("Copied to clipboard.");
      }catch(e){
        showToast("Copy blocked by browser (iPad Safari).");
      }
    });

    
    

    bindNav();
    showCard(0);
    updateConditional();
    validateCard(0);
  </script>
</body>
</html>








