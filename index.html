<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI Scent Matching — Maison Margiela (Demo)</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --card:#ffffff;
      --ink:#111111;
      --muted:#6b6b6b;
      --line:#e8e8e8;
      --shadow:0 16px 42px rgba(0,0,0,.08);
      --shadow2:0 10px 26px rgba(0,0,0,.10);
      --radius:18px;
      --radius2:14px;
      --btn:#111;
      --btnText:#fff;
      --danger:#b00020;
      --safe:#0b6b3a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, system-ui, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:980px;margin:0 auto;padding:18px 18px 34px;}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;padding:12px 6px 4px;}
    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand .kicker{letter-spacing:.18em;text-transform:uppercase;font-size:11px;color:var(--muted);}
    .brand h1{margin:0;font-size:20px;letter-spacing:.02em;font-weight:600;}
    .brand .sub{margin:0;font-size:13px;color:var(--muted);line-height:1.35;max-width:560px;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;
      background:rgba(255,255,255,.7);border:1px solid var(--line);
      border-radius:999px;box-shadow:0 8px 22px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);user-select:none;
    }
    .pill b{font-size:12px}
    .pill span{font-size:12px;color:var(--muted)}

    .progressWrap{
      margin:10px 6px 14px;padding:14px 14px 12px;background:rgba(255,255,255,.7);
      border:1px solid var(--line);border-radius:var(--radius2);
      box-shadow:0 10px 28px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);
    }
    .progressRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .progressRow .label{font-size:12px;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;}
    .progressRow .stepText{font-size:12px;color:var(--muted);}
    .bar{height:8px;border-radius:999px;background:#e9e9e9;overflow:hidden;}
    .bar>i{display:block;height:100%;width:0%;background:#111;border-radius:999px;transition:width .35s ease;}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .hero{padding:22px 22px 10px;border-bottom:1px solid var(--line);background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0));}
    .hero .title{margin:0 0 6px;font-size:18px;font-weight:650;letter-spacing:.01em;}
    .hero .hint{margin:0;font-size:13px;color:var(--muted);line-height:1.4;}

    .step{display:none;padding:18px 22px 22px;animation:fadeUp .28s ease both;}
    .step.active{display:block}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .q{margin:2px 0 12px;font-size:15px;font-weight:650;letter-spacing:.01em;}
    .qmeta{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;color:var(--muted);font-size:12px;}
    .qmeta .limit{padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#fafafa;}

    .grid{display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:10px;}
    @media (min-width:860px){.grid.grid-3{grid-template-columns:repeat(3, minmax(0, 1fr));}}
    @media (max-width:520px){.grid{grid-template-columns:1fr;}}

    .opt{
      border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px 12px;cursor:pointer;
      user-select:none;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      min-height:48px;display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .opt:active{transform:scale(.99);}
    .opt:hover{box-shadow:0 10px 22px rgba(0,0,0,.06);}
    .opt .txt{font-size:14px;font-weight:600;}
    .opt .mini{font-size:12px;color:var(--muted);font-weight:500;}
    .opt .mark{
      width:22px;height:22px;border-radius:999px;border:1px solid var(--line);
      display:grid;place-items:center;font-size:13px;color:transparent;background:#fff;flex:0 0 auto;transition:all .12s ease;
    }
    .opt.on{border-color:#111;background:#111;color:#fff;box-shadow:var(--shadow2);}
    .opt.on .mini{color:rgba(255,255,255,.75);}
    .opt.on .mark{border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.12);color:#fff;}

    .input{
      width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      font-size:14px;outline:none;transition:box-shadow .12s ease, border-color .12s ease;background:#fff;
    }
    .input:focus{border-color:#111;box-shadow:0 0 0 4px rgba(0,0,0,.06);}

    .controls{
      display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;
      border-top:1px solid var(--line);background:#fff;
    }
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:650;font-size:14px;cursor:pointer;
      transition:transform .12s ease, opacity .12s ease, box-shadow .12s ease, background .12s ease;user-select:none;min-width:120px;
    }
    .btn:active{transform:scale(.99);}
    .btn.primary{background:var(--btn);color:var(--btnText);box-shadow:0 14px 30px rgba(0,0,0,.18);}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink);}
    .btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;}
    .note{font-size:12px;color:var(--muted);flex:1;text-align:center;padding:0 8px;}
    .warn{color:var(--danger);font-weight:650;}
    .ok{color:var(--safe);font-weight:650;}

    /* Results */
    .personaBox{
      padding:14px;border-radius:14px;border:1px solid var(--line);background:#fafafa;margin:12px 0 6px;
    }
    .personaBox .p1{font-size:12px;color:var(--muted);margin:0 0 4px;letter-spacing:.14em;text-transform:uppercase;}
    .personaBox .p2{margin:0;font-size:15px;font-weight:800;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .chip{background:#f1f1f1;color:#111;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);}

    .gallery{
      display:flex;gap:12px;overflow-x:auto;padding:12px 2px 2px;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory;
    }
    .gallery::-webkit-scrollbar{height:8px;}
    .gallery::-webkit-scrollbar-thumb{background:#e1e1e1;border-radius:999px;}

    .scentCard{
      flex:0 0 300px;scroll-snap-align:start;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff;
      box-shadow:0 14px 30px rgba(0,0,0,.08);transform:translateY(8px);opacity:0;animation:cardIn .35s ease forwards;
    }
    @keyframes cardIn{to{transform:translateY(0);opacity:1;}}
    .scentTop{padding:14px 14px 12px;border-bottom:1px solid var(--line);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .rank{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);}
    .sname{margin:4px 0 0;font-size:16px;font-weight:800;letter-spacing:.01em;}
    .scentBody{padding:14px;display:grid;grid-template-columns:110px 1fr;gap:12px;align-items:center;}
    .imgWrap{
      width:110px;height:140px;border:1px solid var(--line);border-radius:14px;background:#fbfbfb;display:grid;place-items:center;overflow:hidden;position:relative;
    }
    .imgWrap img{width:100%;height:100%;object-fit:cover;display:block;}
    .imgHint{
      position:absolute;bottom:8px;left:8px;right:8px;font-size:11px;color:rgba(17,17,17,.65);
      background:rgba(255,255,255,.75);border:1px solid var(--line);border-radius:999px;padding:5px 8px;text-align:center;
      backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);
    }
    .sdesc{margin:0;font-size:13px;color:var(--muted);line-height:1.4;}
    .tags{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
    .tag{background:#f3f3f3;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#111;}
    .ctaRow{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;}
    .miniBtn{
      border:1px solid var(--line);background:#fff;color:#111;border-radius:12px;padding:10px 12px;font-size:13px;font-weight:650;cursor:pointer;
    }

    /* Toast */
    .toast{position:fixed;left:18px;right:18px;bottom:18px;max-width:980px;margin:0 auto;display:none;z-index:50;}
    .toast .tbox{
      background:#111;color:#fff;padding:12px 14px;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.22);
      display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:13px;
    }
    .toast button{border:none;background:rgba(255,255,255,.12);color:#fff;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="kicker">AI SCENT MATCHING · DEMO</div>
        <h1>Maison Margiela — Replica</h1>
        <p class="sub">Answer step-by-step. The system outputs <b>Top 3</b> recommended scents as swipeable cards (iPad-ready).</p>
      </div>
      <div class="pill" id="pillState">
        <b id="pillTitle">Live Demo</b>
        <span id="pillSub">Touch-friendly</span>
      </div>
    </div>

    <div class="progressWrap">
      <div class="progressRow">
        <div class="label">progress</div>
        <div class="stepText" id="stepText">Step 1 / 9</div>
      </div>
      <div class="bar"><i id="barFill"></i></div>
    </div>

    <div class="card">
      <div class="hero">
        <p class="title" id="heroTitle">Scent Preference Test</p>
        <p class="hint" id="heroHint">Go with your intuition. Your choices are mapped to scent families + usage contexts.</p>
      </div>

      <!-- Step 1 -->
      <div class="step active" data-step="0">
        <div class="q">1) Are you new to fragrance or an experienced user?</div>
        <div class="qmeta"><div>Used to set “safe” vs “bold” recommendation boundaries.</div><div class="limit">Single choice</div></div>
        <div class="grid">
          <div class="opt" data-q="level" data-type="single" data-val="beginner">
            <div><div class="txt">First-time user</div><div class="mini">Easy-to-wear, low aggressiveness</div></div><div class="mark">✓</div>
          </div>
          <div class="opt" data-q="level" data-type="single" data-val="expert">
            <div><div class="txt">Experienced</div><div class="mini">More character & layering</div></div><div class="mark">✓</div>
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step" data-step="1">
        <div class="q">2) In which situations do you wear fragrance? (Select up to 3)</div>
        <div class="qmeta"><div>Determines “role allocation” (daily / work / evening).</div><div class="limit">Multi (max 3)</div></div>
        <div class="grid grid-3">
          <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="daily">
            <div><div class="txt">Daily life</div><div class="mini">Clean / effortless</div></div><div class="mark">✓</div>
          </div>
          <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="work">
            <div><div class="txt">Work / business</div><div class="mini">Elegant / controlled</div></div><div class="mark">✓</div>
          </div>
          <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="date">
            <div><div class="txt">Date / dinner</div><div class="mini">Warm / attractive</div></div><div class="mark">✓</div>
          </div>
          <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="travel">
            <div><div class="txt">Travel / holiday</div><div class="mini">Airy / freedom</div></div><div class="mark">✓</div>
          </div>
          <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="sport">
            <div><div class="txt">Sport / active</div><div class="mini">Fresh / light</div></div><div class="mark">✓</div>
          </div>
          <div class="opt" data-q="scene" data-type="multi" data-max="3" data-val="event">
            <div><div class="txt">Formal event</div><div class="mini">Statement / bold</div></div><div class="mark">✓</div>
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="step" data-step="2">
        <div class="q">3) Which city do you spend most of the year in?</div>
        <div class="qmeta"><div>Used for environment adjustment (cool/warm, dry/humid).</div><div class="limit">Input</div></div>
        <input class="input" id="cityInput" placeholder="e.g., Paris / Tokyo / London / Shanghai / Singapore" />
        <div class="qmeta" style="margin-top:10px"><div>You can leave it blank for demo.</div><div class="limit">Optional</div></div>
      </div>

      <!-- Step 4 -->
      <div class="step" data-step="3">
        <div class="q">4) Which scent atmospheres do you prefer? (Select up to 2)</div>
        <div class="qmeta"><div>Memory-based anchors that quickly narrow direction.</div><div class="limit">Multi (max 2)</div></div>
        <div class="grid grid-3">
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="rain"><div class="txt">After the rain</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="coffee"><div class="txt">Coffee & vanilla</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="paper"><div class="txt">Books & woods</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="whitefloral"><div class="txt">Rose & white flowers</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="citrus"><div class="txt">Citrus & sunshine</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="bread"><div class="txt">Freshly baked bread</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="oldwood"><div class="txt">Old wooden furniture</div><div class="mark">✓</div></div>
          <div class="opt" data-q="vibe" data-type="multi" data-max="2" data-val="laundry"><div class="txt">Clean laundry</div><div class="mark">✓</div></div>
        </div>
      </div>

      <!-- Step 5 -->
      <div class="step" data-step="4">
        <div class="q">5) Which scent families attract you most? (Select up to 2)</div>
        <div class="qmeta"><div>Primary scent-family preference.</div><div class="limit">Multi (max 2)</div></div>
        <div class="grid grid-3">
          <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="citrus"><div class="txt">Citrus</div><div class="mini">bright / crisp</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="floral"><div class="txt">Floral</div><div class="mini">petal / soft</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="amber"><div class="txt">Amber / sweet</div><div class="mini">warm / comforting</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="woody"><div class="txt">Woody</div><div class="mini">dry / structured</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="family" data-type="multi" data-max="2" data-val="green"><div class="txt">Green / herbal</div><div class="mini">airy / natural</div></div><div class="mark">✓</div></div>
        </div>
      </div>

      <!-- Step 6 (conditional) -->
      <div class="step" data-step="5">
        <div class="q" id="q6Title">6) Preference detail</div>
        <div class="qmeta"><div id="q6Hint">This question adapts to your selection in Step 5.</div><div class="limit">Single choice</div></div>

        <!-- Sweetness -->
        <div id="sweetBlock" style="display:none">
          <div class="qmeta" style="margin-top:0"><div><b>Sweetness tolerance</b> (for Citrus / Floral / Amber)</div><div class="limit">Single</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="sweetness" data-type="single" data-val="none"><div class="txt">Not at all</div><div class="mini">dry / clean</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="sweetness" data-type="single" data-val="light"><div class="txt">Light</div><div class="mini">a touch of sweetness</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="sweetness" data-type="single" data-val="medium"><div class="txt">Moderate</div><div class="mini">balanced</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="sweetness" data-type="single" data-val="high"><div class="txt">Sweet</div><div class="mini">comforting / gourmand</div></div><div class="mark">✓</div></div>
          </div>
        </div>

        <!-- Smoky -->
        <div id="smokyBlock" style="display:none;margin-top:14px">
          <div class="qmeta" style="margin-top:0"><div><b>Smoky / leather / oud tolerance</b> (for Woody / Green)</div><div class="limit">Single</div></div>
          <div class="grid grid-3">
            <div class="opt" data-q="smoky" data-type="single" data-val="none"><div class="txt">Not at all</div><div class="mini">clean woods</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="smoky" data-type="single" data-val="low"><div class="txt">A little</div><div class="mini">subtle depth</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="smoky" data-type="single" data-val="medium"><div class="txt">Moderate</div><div class="mini">noticeable</div></div><div class="mark">✓</div></div>
            <div class="opt" data-q="smoky" data-type="single" data-val="high"><div class="txt">I love it</div><div class="mini">bold & smoky</div></div><div class="mark">✓</div></div>
          </div>
        </div>
      </div>

      <!-- Step 7 -->
      <div class="step" data-step="6">
        <div class="q">7) Do you prefer fresh or intense scents?</div>
        <div class="qmeta"><div>Used to tune projection & richness.</div><div class="limit">Single choice</div></div>
        <div class="grid grid-3">
          <div class="opt" data-q="intensity" data-type="single" data-val="very-fresh"><div><div class="txt">Very fresh</div><div class="mini">airy / clean</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="intensity" data-type="single" data-val="balanced"><div><div class="txt">Balanced</div><div class="mini">versatile</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="intensity" data-type="single" data-val="rich"><div><div class="txt">More intense</div><div class="mini">deeper</div></div><div class="mark">✓</div></div>
          <div class="opt" data-q="intensity" data-type="single" data-val="very-rich"><div><div class="txt">Very intense</div><div class="mini">statement</div></div><div class="mark">✓</div></div>
        </div>
      </div>

      <!-- Step 8 -->
      <div class="step" data-step="7">
        <div class="q">8) What impression do you want to leave?</div>
        <div class="qmeta"><div>Defines your “scent persona”.</div><div class="limit">Multi (max 2)</div></div>
        <div class="grid grid-3">
          <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="clean">Clean & professional<div class="mark">✓</div></div>
          <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="soft">Soft & comforting<div class="mark">✓</div></div>
          <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="cool">Cool & luxurious<div class="mark">✓</div></div>
          <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="sexy">Seductive<div class="mark">✓</div></div>
          <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="relaxed">Relaxed & effortless<div class="mark">✓</div></div>
          <div class="opt" data-q="impression" data-type="multi" data-max="2" data-val="mysterious">Mysterious & unique<div class="mark">✓</div></div>
        </div>
      </div>

      <!-- Step 9 (Results) -->
      <div class="step" data-step="8">
        <div class="q">Your Results</div>
        <div class="qmeta"><div>Swipe the cards horizontally on iPad.</div><div class="limit">Top 3</div></div>

        <div class="personaBox">
          <p class="p1">Your Scent Persona</p>
          <p class="p2" id="personaLine">—</p>
          <div class="chips" id="chipLine"></div>
        </div>

        <div class="gallery" id="gallery"></div>

        <div class="ctaRow">
          <button class="miniBtn" type="button" id="btnRestart">Restart</button>
          <button class="miniBtn" type="button" id="btnCopy">Copy summary</button>
        </div>
      </div>

      <div class="controls">
        <button class="btn ghost" type="button" id="btnBack">Back</button>
        <div class="note" id="note">Select options to continue.</div>
        <button class="btn primary" type="button" id="btnNext">Next</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="tbox">
      <div id="toastMsg">Saved</div>
      <button type="button" id="toastBtn">OK</button>
    </div>
  </div>

  <script>
    // ---------- State ----------
    const state = {
      level: null,                 // beginner | expert
      scene: [],                   // up to 3
      city: "",
      vibe: [],                    // up to 2
      family: [],                  // up to 2
      sweetness: null,             // none | light | medium | high
      smoky: null,                 // none | low | medium | high
      intensity: null,             // very-fresh | balanced | rich | very-rich
      impression: []               // up to 2
    };

    const steps = Array.from(document.querySelectorAll(".step"));
    const totalSteps = steps.length; // 9
    let current = 0;

    const elStepText = document.getElementById("stepText");
    const elBarFill  = document.getElementById("barFill");
    const elNote     = document.getElementById("note");
    const btnBack    = document.getElementById("btnBack");
    const btnNext    = document.getElementById("btnNext");

    const toast       = document.getElementById("toast");
    const toastMsg    = document.getElementById("toastMsg");
    const toastBtn    = document.getElementById("toastBtn");

    const cityInput = document.getElementById("cityInput");

    // Conditional blocks
    const sweetBlock = document.getElementById("sweetBlock");
    const smokyBlock = document.getElementById("smokyBlock");

    // Results
    const personaLine = document.getElementById("personaLine");
    const chipLine    = document.getElementById("chipLine");
    const gallery     = document.getElementById("gallery");
    const btnRestart  = document.getElementById("btnRestart");
    const btnCopy     = document.getElementById("btnCopy");

    // ---------- Helpers ----------
    function showToast(msg){
      toastMsg.textContent = msg;
      toast.style.display = "block";
      toastBtn.onclick = () => (toast.style.display = "none");
      setTimeout(() => { toast.style.display = "none"; }, 2200);
    }

    function setStep(i){
      current = Math.max(0, Math.min(totalSteps - 1, i));
      steps.forEach(s => s.classList.remove("active"));
      steps[current].classList.add("active");
      elStepText.textContent = `Step ${current + 1} / ${totalSteps}`;
      elBarFill.style.width = `${((current) / (totalSteps - 1)) * 100}%`;

      btnBack.disabled = current === 0;
      btnNext.textContent = (current === totalSteps - 1) ? "Done" : (current === totalSteps - 2 ? "See results" : "Next");

      refreshNoteAndNext();
      if (current === totalSteps - 1) btnNext.disabled = true;

      // focus
      if (current === 2) { setTimeout(() => cityInput.focus(), 100); }
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function refreshNoteAndNext(){
      // Validate minimal completion per step (except optional city)
      let ok = true;
      let msg = "Select options to continue.";

      if (current === 0 && !state.level){ ok=false; msg="Please select one option."; }
      if (current === 1 && state.scene.length === 0){ ok=false; msg="Select at least one context."; }
      if (current === 2){ ok=true; msg="Optional — you can skip."; }
      if (current === 3 && state.vibe.length === 0){ ok=false; msg="Select 1–2 atmospheres."; }
      if (current === 4 && state.family.length === 0){ ok=false; msg="Select 1–2 scent families."; }

      if (current === 5){
        // conditional required if block shown
        const needsSweet = shouldAskSweetness();
        const needsSmoky = shouldAskSmoky();
        if (needsSweet && !state.sweetness){ ok=false; msg="Select your sweetness tolerance."; }
        if (needsSmoky && !state.smoky){ ok=false; msg="Select your smoky tolerance."; }
        if (!needsSweet && !needsSmoky){ ok=true; msg="Optional — you can continue."; }
      }

      if (current === 6 && !state.intensity){ ok=false; msg="Please select one option."; }
      if (current === 7 && state.impression.length === 0){ ok=false; msg="Select up to 2 impressions."; }

      btnNext.disabled = !ok;
      elNote.innerHTML = ok ? `<span class="ok">Ready.</span>` : `<span class="warn">${msg}</span>`;
    }

    function shouldAskSweetness(){
      // Sweetness relevant for Citrus / Floral / Amber
      return state.family.some(x => ["citrus","floral","amber"].includes(x));
    }
    function shouldAskSmoky(){
      // Smoky relevant for Woody / Green
      return state.family.some(x => ["woody","green"].includes(x));
    }

    function updateConditionalStep(){
      const sweet = shouldAskSweetness();
      const smoky = shouldAskSmoky();
      sweetBlock.style.display = sweet ? "block" : "none";
      smokyBlock.style.display = smoky ? "block" : "none";

      // If not needed, clear to avoid bias
      if (!sweet) state.sweetness = null;
      if (!smoky) state.smoky = null;

      // Update the visual selection state in conditional blocks
      document.querySelectorAll('[data-q="sweetness"]').forEach(el => el.classList.toggle("on", el.dataset.val === state.sweetness));
      document.querySelectorAll('[data-q="smoky"]').forEach(el => el.classList.toggle("on", el.dataset.val === state.smoky));
    }

    function toggleOption(el){
      const q = el.dataset.q;
      const type = el.dataset.type;
      const val = el.dataset.val;

      if (type === "single"){
        state[q] = val;
        document.querySelectorAll(`.opt[data-q="${q}"]`).forEach(x => x.classList.remove("on"));
        el.classList.add("on");
      } else {
        const max = parseInt(el.dataset.max || "99", 10);
        const arr = state[q] || [];
        const idx = arr.indexOf(val);

        if (idx >= 0){
          arr.splice(idx, 1);
          el.classList.remove("on");
        } else {
          if (arr.length >= max){
            showToast(`Max ${max} selections.`);
            return;
          }
          arr.push(val);
          el.classList.add("on");
        }
        state[q] = arr;
      }

      if (q === "family") updateConditionalStep();
      refreshNoteAndNext();
    }

    function bindOptions(){
      document.querySelectorAll(".opt").forEach(el => {
        el.addEventListener("click", () => toggleOption(el), {passive:true});
      });
    }

    function bindInputs(){
      cityInput.addEventListener("input", () => {
        state.city = cityInput.value.trim();
      });
    }

    // ---------- Scoring & Matching ----------
    // Note: This is a demo recommender. It uses heuristic weights based on your questionnaire.
    const scents = [
      {
        key:"lazy_sunday_morning",
        name:"Lazy Sunday Morning",
        img:"https://images.unsplash.com/photo-1526045478516-99145907023c?auto=format&fit=crop&w=800&q=70",
        tags:["Clean","Musky","Soft Floral"],
        desc:"Clean linen, soft musk, gentle florals — effortless and intimate.",
        vec:{ fresh:3, floral:2, amber:0, woody:0, green:1, clean:3, sweet:0, smoky:0, bold:0 }
      },
      {
        key:"bubble_bath",
        name:"Bubble Bath",
        img:"https://images.unsplash.com/photo-1583947215259-38e31be8751f?auto=format&fit=crop&w=800&q=70",
        tags:["Soapy","Coconut","Clean"],
        desc:"Soapy cleanliness with a cozy skin-like comfort.",
        vec:{ fresh:3, floral:1, amber:0, woody:0, green:1, clean:3, sweet:1, smoky:0, bold:0 }
      },
      {
        key:"sailing_day",
        name:"Sailing Day",
        img:"https://images.unsplash.com/photo-1500375592092-40eb2168fd21?auto=format&fit=crop&w=800&q=70",
        tags:["Marine","Fresh","Aromatic"],
        desc:"Oceanic freshness and airy aromatics — crisp and uplifting.",
        vec:{ fresh:4, floral:0, amber:0, woody:0, green:2, clean:2, sweet:0, smoky:0, bold:0 }
      },
      {
        key:"springtime_in_a_park",
        name:"Springtime in a Park",
        img:"https://images.unsplash.com/photo-1520975958225-9c915b1d65a6?auto=format&fit=crop&w=800&q=70",
        tags:["Floral","Green","Bright"],
        desc:"A bright floral bouquet with a fresh spring breeze.",
        vec:{ fresh:2, floral:4, amber:0, woody:0, green:2, clean:1, sweet:1, smoky:0, bold:0 }
      },
      {
        key:"coffee_break",
        name:"Coffee Break",
        img:"https://images.unsplash.com/photo-1511920170033-f8396924c348?auto=format&fit=crop&w=800&q=70",
        tags:["Coffee","Creamy","Warm"],
        desc:"Coffee-laced comfort with a creamy sweetness.",
        vec:{ fresh:0, floral:1, amber:4, woody:1, green:0, clean:0, sweet:3, smoky:0, bold:1 }
      },
      {
        key:"jazz_club",
        name:"Jazz Club",
        img:"https://images.unsplash.com/photo-1520975682031-a8b4b6b1c7b1?auto=format&fit=crop&w=800&q=70",
        tags:["Rum","Tobacco","Amber"],
        desc:"Warm rum, tobacco and amber — charismatic and nocturnal.",
        vec:{ fresh:0, floral:0, amber:4, woody:2, green:0, clean:0, sweet:2, smoky:1, bold:2 }
      },
      {
        key:"by_the_fireplace",
        name:"By the Fireplace",
        img:"https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=800&q=70",
        tags:["Smoky","Woods","Vanilla"],
        desc:"Smoky woods and toasted warmth — iconic winter comfort.",
        vec:{ fresh:0, floral:0, amber:3, woody:4, green:0, clean:0, sweet:2, smoky:3, bold:2 }
      },
      {
        key:"whispers_in_the_library",
        name:"Whispers in the Library",
        img:"https://images.unsplash.com/photo-1455885666463-65e6c4d5b0b4?auto=format&fit=crop&w=800&q=70",
        tags:["Paper","Woods","Soft Spice"],
        desc:"Paper, woods and soft spice — quiet, intellectual, refined.",
        vec:{ fresh:1, floral:0, amber:1, woody:4, green:0, clean:1, sweet:0, smoky:0, bold:1 }
      }
    ];

    function buildUserVector(){
      const v = { fresh:0, floral:0, amber:0, woody:0, green:0, clean:0, sweet:0, smoky:0, bold:0 };

      // Level
      if (state.level === "beginner"){ v.clean += 1; v.bold -= 1; }
      if (state.level === "expert"){ v.bold += 1; }

      // Scene
      const s = new Set(state.scene);
      if (s.has("daily")){ v.clean += 2; v.fresh += 1; }
      if (s.has("work")){ v.clean += 1; v.woody += 1; }
      if (s.has("date")){ v.amber += 1; v.bold += 1; }
      if (s.has("travel")){ v.fresh += 2; v.green += 1; }
      if (s.has("sport")){ v.fresh += 2; v.clean += 1; }
      if (s.has("event")){ v.bold += 2; v.amber += 1; v.woody += 1; }

      // Vibe
      const vibeMap = {
        rain: { fresh:2, green:1 },
        coffee: { amber:2, sweet:1 },
        paper: { woody:2 },
        whitefloral: { floral:2, clean:1 },
        citrus: { fresh:2 },
        bread: { amber:2, sweet:1 },
        oldwood: { woody:2 },
        laundry: { clean:2, fresh:1 }
      };
      state.vibe.forEach(x => {
        const m = vibeMap[x];
        if (!m) return;
        Object.keys(m).forEach(k => v[k] += m[k]);
      });

      // Family
      state.family.forEach(x => {
        if (x === "citrus") v.fresh += 3;
        if (x === "floral") v.floral += 3;
        if (x === "amber") v.amber += 3;
        if (x === "woody") v.woody += 3;
        if (x === "green") v.green += 3;
      });

      // Sweetness tolerance
      const sweetMap = { none:0, light:1, medium:2, high:3 };
      if (state.sweetness) v.sweet += sweetMap[state.sweetness] ?? 0;

      // Smoky tolerance
      const smokyMap = { none:0, low:1, medium:2, high:3 };
      if (state.smoky) v.smoky += smokyMap[state.smoky] ?? 0;

      // Intensity
      if (state.intensity === "very-fresh"){ v.fresh += 2; v.bold -= 1; }
      if (state.intensity === "balanced"){ v.fresh += 1; v.amber += 1; }
      if (state.intensity === "rich"){ v.amber += 2; v.bold += 1; }
      if (state.intensity === "very-rich"){ v.amber += 3; v.bold += 2; v.woody += 1; }

      // Impression
      const imp = new Set(state.impression);
      if (imp.has("clean")){ v.clean += 2; v.fresh += 1; }
      if (imp.has("soft")){ v.floral += 1; v.clean += 1; }
      if (imp.has("cool")){ v.woody += 1; v.clean += 1; }
      if (imp.has("sexy")){ v.amber += 2; v.bold += 1; }
      if (imp.has("relaxed")){ v.fresh += 1; v.green += 1; }
      if (imp.has("mysterious")){ v.woody += 1; v.smoky += 1; v.bold += 1; }

      // City (light heuristic)
      const c = (state.city || "").toLowerCase();
      if (c.includes("paris")){ v.floral += 1; v.clean += 1; }
      if (c.includes("tokyo")){ v.clean += 2; v.fresh += 1; }
      if (c.includes("london")){ v.woody += 1; v.amber += 1; }
      if (c.includes("singapore")){ v.fresh += 2; v.green += 1; }
      if (c.includes("shanghai")){ v.clean += 1; v.fresh += 1; }

      return v;
    }

    function scoreScent(userV, scent){
      // dot product with slight penalties for mismatch extremes
      let score = 0;
      for (const k in scent.vec){
        score += (userV[k] || 0) * (scent.vec[k] || 0);
      }
      // penalty: if user hates smoky but scent is smoky
      if ((userV.smoky || 0) === 0 && scent.vec.smoky >= 2) score -= 6;
      // penalty: if user hates sweet but scent is gourmand
      if ((userV.sweet || 0) === 0 && scent.vec.sweet >= 2) score -= 5;
      return score;
    }

    function buildPersona(userV){
      const parts = [];

      // Context label
      const s = new Set(state.scene);
      let context = "Everyday";
      if (s.has("work") && !s.has("event") && !s.has("date")) context = "Work-ready";
      if (s.has("date") || s.has("event")) context = "Evening";
      if (s.has("travel")) context = "Travel";
      parts.push(context);

      // Core direction
      const core = Object.entries({
        Clean: userV.clean,
        Fresh: userV.fresh,
        Floral: userV.floral,
        Woody: userV.woody,
        Amber: userV.amber
      }).sort((a,b)=>b[1]-a[1])[0][0];
      parts.push(core);

      // Attitude
      const att = (userV.bold >= 3) ? "Statement" : (userV.clean >= 4 ? "Minimal" : "Balanced");
      parts.push(att);

      return parts.join(" · ");
    }

    function renderResults(){
      const userV = buildUserVector();
      const ranked = scents
        .map(s => ({...s, _score: scoreScent(userV, s)}))
        .sort((a,b)=>b._score-a._score);

      const top3 = ranked.slice(0,3);
      const persona = buildPersona(userV);

      personaLine.textContent = persona;

      // chips summary
      chipLine.innerHTML = "";
      const chips = [];
      if (state.level) chips.push(state.level === "beginner" ? "First-time user" : "Experienced");
      if (state.scene.length) chips.push(...state.scene.map(x => ({
        daily:"Daily life", work:"Work", date:"Date", travel:"Travel", sport:"Sport", event:"Event"
      }[x])));
      if (state.family.length) chips.push(...state.family.map(x => ({
        citrus:"Citrus", floral:"Floral", amber:"Amber/Sweet", woody:"Woody", green:"Green/Herbal"
      }[x])));
      if (state.intensity) chips.push({
        "very-fresh":"Very fresh", "balanced":"Balanced", "rich":"More intense", "very-rich":"Very intense"
      }[state.intensity]);
      if (state.impression.length) chips.push(...state.impression.map(x => ({
        clean:"Clean", soft:"Soft", cool:"Cool", sexy:"Seductive", relaxed:"Relaxed", mysterious:"Mysterious"
      }[x])));

      chips.slice(0,10).forEach(t => {
        const d = document.createElement("div");
        d.className = "chip";
        d.textContent = t;
        chipLine.appendChild(d);
      });

      // cards
      gallery.innerHTML = "";
      top3.forEach((p, idx) => {
        const card = document.createElement("div");
        card.className = "scentCard";
        card.style.animationDelay = `${idx * 90}ms`;
        card.innerHTML = `
          <div class="scentTop">
            <div>
              <div class="rank">Top ${idx+1}</div>
              <div class="sname">${p.name}</div>
            </div>
            <div class="rank">${Math.round(p._score)}</div>
          </div>
          <div class="scentBody">
            <div class="imgWrap">
              <img src="${p.img}" alt="${p.name}">
              <div class="imgHint">Swipe for more</div>
            </div>
            <div>
              <p class="sdesc">${p.desc}</p>
              <div class="tags">
                ${p.tags.map(t => `<span class="tag">${t}</span>`).join("")}
              </div>
            </div>
          </div>
        `;
        gallery.appendChild(card);
      });
    }

    // ---------- Navigation ----------
    btnBack.addEventListener("click", () => {
      if (current > 0) setStep(current - 1);
    });

    btnNext.addEventListener("click", () => {
      if (current < totalSteps - 1){
        // before moving into conditional step, ensure blocks are accurate
        if (current === 4) updateConditionalStep();

        // If going to results, render
        if (current === totalSteps - 2){
          renderResults();
        }
        setStep(current + 1);
      }
    });

    btnRestart.addEventListener("click", () => {
      // reset state
      state.level = null;
      state.scene = [];
      state.city = "";
      state.vibe = [];
      state.family = [];
      state.sweetness = null;
      state.smoky = null;
      state.intensity = null;
      state.impression = [];

      // reset UI
      document.querySelectorAll(".opt").forEach(el => el.classList.remove("on"));
      cityInput.value = "";
      sweetBlock.style.display = "none";
      smokyBlock.style.display = "none";
      showToast("Restarted.");
      setStep(0);
    });

    btnCopy.addEventListener("click", async () => {
      const lines = [];
      lines.push("AI Scent Matching — Summary");
      lines.push(`Level: ${state.level === "beginner" ? "First-time user" : "Experienced"}`);
      lines.push(`Contexts: ${(state.scene||[]).join(", ") || "-"}`);
      lines.push(`City: ${state.city || "-"}`);
      lines.push(`Atmospheres: ${(state.vibe||[]).join(", ") || "-"}`);
      lines.push(`Families: ${(state.family||[]).join(", ") || "-"}`);
      lines.push(`Sweetness: ${state.sweetness || "-"}`);
      lines.push(`Smoky: ${state.smoky || "-"}`);
      lines.push(`Intensity: ${state.intensity || "-"}`);
      lines.push(`Impression: ${(state.impression||[]).join(", ") || "-"}`);
      const txt = lines.join("\n");
      try{
        await navigator.clipboard.writeText(txt);
        showToast("Copied to clipboard.");
      }catch(e){
        showToast("Copy failed. (iPad Safari may block clipboard.)");
      }
    });

    // ---------- Bind UI ----------
    bindOptions();
    bindInputs();

    // Keep note updated on load
    setStep(0);

    // Also update conditional if user edits family then goes back/forth
    document.addEventListener("click", (e) => {
      const t = e.target.closest(".opt");
      if (!t) return;
      if (t.dataset.q === "family") updateConditionalStep();
    }, {passive:true});
  </script>
</body>
</html>
